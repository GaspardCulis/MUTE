---

---

<div id="title-view"></div>
<script>
  import * as THREE from "three";
  import {
    createRenderer,
    createScene,
    createTitleText,
  } from "../lib/TitleRenderer.ts";
  import Font from "../lib/Font";
  import Editor from "../lib/Editor";

  const editor = Editor.get();

  const texture_loader = new THREE.TextureLoader();

  async function generateTitle(scene: THREE.Scene): Promise<void> {
    scene.clear();

    const title_group = new THREE.Group();
    for (const row of ["top", "middle", "bottom"]) {
      // @ts-ignore
      const top_config = editor.variables[`title.${row}`].get() as StyledText;
      const text_group = await createTitleText(
        top_config.text,
        texture_loader,
        {
          font: await Font.load(top_config.font),
          // @ts-ignore
          type: row,
        },
      );

      title_group.add(text_group);
    }

    scene.add(title_group);
    requestAnimationFrame(() => {
      renderer.render(scene, camera);
      editor.download_url = renderer.domElement.toDataURL();
    });
  }

  const container = document.querySelector("#title-view") as HTMLDivElement;

  const w = container.clientWidth;
  const h = container.clientHeight;

  const renderer = createRenderer(container);
  const [scene, camera] = createScene(w, h);

  await generateTitle(scene);

  editor.variables["title.top"].on("changed", (_v) => generateTitle(scene));
  editor.variables["title.middle"].on("changed", (_v) => generateTitle(scene));
  editor.variables["title.bottom"].on("changed", (_v) => generateTitle(scene));
</script>
<style>
  #title-view {
    width: 100%;
    height: 260px;
  }
</style>
